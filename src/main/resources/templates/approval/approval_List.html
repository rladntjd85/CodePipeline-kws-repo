<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<th:block layout:fragment="style">
<style>
/* 테이블 */
.table-compact th, .table-compact td { padding: 0.5rem; vertical-align: middle; }

/* 결재 상태 배지 - 공통 */
.approval-status-badge {
    font-size: 0.8rem; padding: 0.4rem 0.8rem; border-radius: 20px;
    font-weight: 500; display: inline-block; text-align: center; 
    min-width: 60px; transition: transform 0.2s ease;
}
.approval-status-badge:hover { transform: scale(1.05); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

/* 상태별 색상 */
.approval-status-approved { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
.approval-status-pending { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
.approval-status-rejected, 
.approval-status-canceled { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
.approval-status-unknown { background: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; }

/* 모달 */
.modal-header { background: #4e73df; color: white; }
#approvalModal .modal-body,
#approvalModal .modal-header,
#approvalModal .modal-footer { padding: 10px; }

/* 정보 영역 */
.info-row { margin-bottom: 15px; padding: 10px; background: #f8f9fc; border-radius: 5px; }
.info-label { font-weight: bold; color: #5a5c69; margin-bottom: 5px; }
.info-value { color: #3a3b45; font-size: 14px; }

/* 0901 체크박스 선택 시 행 하이라이트 */
tr:has(.approval-checkbox:checked) { background: #fff3cd; }
.approval-checkbox { cursor: pointer; }
</style>
</th:block>
</head>

<body>
<th:block layout:fragment="content">
	<div class="container-fluid">
	    <h1 class="h3 mb-4 text-gray-800">인사 결재 목록</h1>
	<div class="card shadow mb-4">
	    <div class="card-body">
	        <form onsubmit="return false;">
	            <div class="row align-items-center">
	                <div class="col-md-4">
	                    <div class="input-group">
	                        <input type="date" class="form-control" value="2025-07-13">
	                        <span class="input-group-text">~</span>
	                        <input type="date" class="form-control" value="2025-08-12">
	                    </div>
	                </div>
<!--                             <div class="col-md-1"> -->
<!--                                 <select class="form-control"> -->
<!--                                     <option selected>결재유형</option> -->
<!--                                     <option value="1">출장</option> -->
<!--                                     <option value="2">인사발령</option> -->
<!--                                     <option value="3">휴가</option> -->
<!--                                 </select> -->
<!--                             </div> -->
<!--                             <div class="col-md-1"> -->
<!--                                 <select class="form-control"> -->
<!--                                     <option selected>부서</option> -->
<!--                                     <option value="1">생산</option> -->
<!--                                     <option value="2">인사</option> -->
<!--                                     <option value="3">재무</option> -->
<!--                                 </select> -->
<!--                             </div> -->
<!--                             <div class="col-md-1"> -->
<!--                                 <select class="form-control"> -->
<!--                                     <option selected>직급</option> -->
<!--                                     <option value="1">사원</option> -->
<!--                                     <option value="2">주임</option> -->
<!--                                     <option value="3">대리</option> -->
<!--                                 </select> -->
<!--                             </div> -->
                        <div class="col-md-3 ml-auto">
                            <input type="text" class="form-control" id="drafterNameInput" placeholder="기안자 입력 후 검색">
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-primary" id="searchButton" type="button">검색</button>
                        </div>
                    </div>
				</form>
			</div>
		</div>

		<div class="card shadow mb-4">
			<div class="card-header py-3">
				<ul class="nav nav-tabs card-header-tabs">
					<li class="nav-item">
						<a class="nav-link" th:classappend="${currentStatus == 'all' ? 'active' : ''}" 
							th:href="@{/approval/approval_list(status='all')}">전체결재</a>
					</li>
					<li class="nav-item">
		  				<a class="nav-link" th:classappend="${currentStatus == 'my' ? 'active' : ''}" 
		   				   	th:href="@{/approval/approval_list(status='my')}">내결재목록</a>
					</li>
		           	<li class="nav-item">
		               	<a class="nav-link" th:classappend="${currentStatus == 'pending' ? 'active' : ''}" 
		                     th:href="@{/approval/approval_list(status='pending')}">결재대기</a>
		            </li>
		            <li class="nav-item">
		                <a class="nav-link" th:classappend="${currentStatus == 'completed' ? 'active' : ''}" 
		                   th:href="@{/approval/approval_list(status='completed')}">결재완료</a>
		            </li>
				</ul>
			</div>
			<div class="card-body">
			     <div class="table-responsive">
			         <table class="table table-hover text-center table-compact" id="dataTable" width="100%" cellspacing="0">
			             <thead>
			                 <tr>
			                 	<!-- 0901 삭제 -->
			                 	<th th:if="${currentStatus == 'my' or currentStatus == 'completed'}">
						            <input type="checkbox" id="selectAll">
						        </th>
								<th>결재순번</th>
								<th>문서제목</th>
								<th>기안자</th>
								<th>부서명</th>
								<th>직급</th>
								<th>생성일</th>
								<th>결재 완료일자</th>
								<th>상태</th>
								<th>결재여부</th>
			                 </tr>
						</thead>
						<tbody>
							<tr th:each="appr, iterStat : ${approvalList}">
								<!-- 0901 삭제 -->
								<td th:if="${currentStatus == 'my' or currentStatus == 'completed'}">
						            <input type="checkbox" class="row-checkbox" th:value="${appr.reqId}">
						        </td>
	                            <td th:text="${totalElements - (currentPage * 5) - iterStat.index}">1</td>
	                            <td th:text="${appr.title}">휴가 신청서</td>
	                            <td class="drafter-name" th:text="${appr.drafterName}">이연수</td>
	                            <td th:text="${appr.department}">재무팀</td>
	                            <td th:text="${appr.position}">대리</td>
	                            <td th:text="${#temporals.format(appr.createAt, 'yyyy-MM-dd')}">2025-08-07</td>
	                            <td th:text="${appr.decDate != null ? #temporals.format(appr.decDate, 'yyyy-MM-dd') : '-'}">-</td>
	                            <td>
									<span th:if="${currentStatus == 'my'}" 
								          th:text="${appr.myApprovalStatus}"
								          th:class="'approval-status-badge ' + 
								                    ${appr.myApprovalStatus == '완료' ? 'approval-status-approved' : 
								                     appr.myApprovalStatus == '진행중' ? 'approval-status-pending' : 
								                     appr.myApprovalStatus == '반려됨' ? 'approval-status-canceled' :
								                     'approval-status-pending'}">
									</span>
							    
								    <span th:unless="${currentStatus == 'my'}"
								          th:text="${appr.statusLabel}" 
								          th:class="'approval-status-badge ' + 
								                   ${appr.statusLabel == '승인' ? 'approval-status-approved' : 
								                     appr.statusLabel == '대기' ? 'approval-status-pending' : 
								                     appr.statusLabel == '반려됨' ? 'approval-status-canceled' : 
								                     'approval-status-unknown'}">
								    </span>
								</td>
								<td>
									<!-- 내결재목록에서 대기 상태인 경우 취소 버튼 표시 -->
								    <button th:if="${currentStatus == 'my' and appr.myApprovalStatus == '대기'}"
								            type="button" class="btn btn-warning btn-sm cancel-approval-btn"
								            th:data-req-id="${appr.reqId}">결재취소</button>
								    
								    <!-- 내결재목록에서 완료/진행중/취소된 경우 상세보기 버튼 -->
								    <button th:if="${currentStatus == 'my' and appr.myApprovalStatus != '대기'}"
								            type="button" class="btn btn-info btn-sm view-approval-btn"
								            th:data-req-id="${appr.reqId}">상세보기</button>
								
								    <!-- 대기 중인 경우 결재하기 버튼 -->
								    <button th:if="${currentStatus != 'my' and appr.statusLabel == '대기'}"
								            type="button" class="btn btn-primary btn-sm approval-btn"
								            th:data-req-id="${appr.reqId}">결재하기</button>
								    
								    <!-- 승인/반려 완료된 경우 결재확인 버튼 -->
								    <button th:if="${currentStatus != 'my' and (appr.statusLabel == '승인' or appr.statusLabel == '반려')}"
								        type="button" class="btn btn-info btn-sm view-approval-btn"
								        th:data-req-id="${appr.reqId}">결재확인</button>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
				
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        <!-- 이전 버튼 -->
                        <li class="page-item" th:classappend="${!hasPrevious} ? 'disabled'">
                            <a class="page-link" 
                               th:href="${hasPrevious} ? @{/approval/approval_list(status=${currentStatus}, page=${currentPage - 1})} : '#'" 
                               tabindex="-1">이전</a>
                        </li>
                        
                        <!-- 페이지 번호들 -->
                        <th:block th:each="i : ${#numbers.sequence(0, totalPages - 1)}" th:if="${totalPages > 0}">
                            <li class="page-item" th:classappend="${i == currentPage} ? 'active'">
                                <a class="page-link" 
                                   th:href="@{/approval/approval_list(status=${currentStatus}, page=${i})}" 
                                   th:text="${i + 1}">1</a>
                            </li>
                        </th:block>
                        
                        <!-- 다음 버튼 -->
                        <li class="page-item" th:classappend="${!hasNext} ? 'disabled'">
                            <a class="page-link" 
                               th:href="${hasNext} ? @{/approval/approval_list(status=${currentStatus}, page=${currentPage + 1})} : '#'">다음</a>
                        </li>
                    </ul>
                    <!-- 0901 삭제 -->
                    <div th:if="${currentStatus == 'my' or currentStatus == 'completed'}" class="mt-2">
						<button type="button" class="btn btn-danger btn-sm" id="deleteBtn" style="display:none;">
						    <i class="fas fa-trash"></i> 선택 삭제
						</button>
					</div> 
                    <!-- 페이지 정보 표시 -->
					<div class="text-center mt-2">
					    <small class="text-muted">
					        총 <span th:text="${totalElements}">0</span>건 중 
					        <span th:text="${currentPage * 5 + 1}">1</span> - 
					        <span th:text="${(currentPage + 1) * 5 > totalElements ? totalElements : (currentPage + 1) * 5}">5</span>건 표시
					    </small>
					</div>
                </nav>
			</div>
		</div>
	</div>
	

    <!-- 결재 모달 -->
	<div class="modal fade" id="approvalModal" tabindex="-1" role="dialog" aria-labelledby="approvalModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
			    <div class="modal-header">
			        <h5 class="modal-title" id="approvalModalLabel">
			            <i class="fas fa-clipboard-check"></i> 결재 문서 상세
			        </h5>
			        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
			            <span aria-hidden="true">&times;</span>
			        </button>
			    </div>
           		<div class="modal-body">
					<div id="modalLoading" class="text-center py-4">
					    <div class="spinner-border text-primary" role="status">
					        <span class="sr-only">로딩중...</span>
					    </div>
					    <p class="mt-2">결재 정보를 불러오는 중입니다...</p>
					</div>
               		<div id="modalContent" style="display: block;">
						<div class="row mb-3">
						    <div class="col-md-4">
						        <div class="info-block">
						            <div class="info-label"><i class="fas fa-file-alt mr-2"></i>결재 정보</div>
						            <div class="info-value">
						                <span id="modal-reqId">14</span> (<span id="modal-reqType">VACATION</span>)
						            </div>
						        </div>
						    </div>
						    <div class="col-md-4">
						        <div class="info-block">
						            <div class="info-label"><i class="fas fa-user-tie mr-2"></i>기안자 정보</div>
						            <div class="info-value">
						                <span id="modal-drafterName">관리자</span> (<span id="modal-department">인사팀</span>)
						            </div>
						        </div>
						    </div>
						    <div class="col-md-4">
						        <div class="info-block">
						            <div class="info-label"><i class="fas fa-calendar-alt mr-2"></i>기안일</div>
						            <div class="info-value" id="modal-createAt">2025-08-27</div>
						        </div>
						    </div>
						</div>
                   		<hr>
		                <div class="card my-3">
						    <div class="card-body">
						        <h5 class="card-title" id="modal-title">문서 제목</h5>
						        <div class="content-box border p-3" id="modal-content-detail" 
						             style="background: #f8f9fa; overflow-x: auto;">
						        </div>
						    </div>
						</div>
						<div class="approval-line-section mt-4">
						<h6 class="approval-line-header"><i class="fas fa-stream"></i> 결재선</h6>
							<table class="table table-bordered table-sm text-center">
							    <thead class="thead-light">
							        <tr>
							            <th style="width: 25%;">기안자</th>
							            <th style="width: 25%;" id="approver-header-1">결재자</th>
							            <th style="width: 25%;" id="approver-header-2">결재자</th>
							            <th style="width: 25%;" id="approver-header-3">결재자</th>
							        </tr>
							    </thead>
							    <tbody id="approval-line-tbody">
							        <!-- JavaScript로 동적 생성 -->
							    </tbody>
							</table>
						    
						    <div id="approval-comments-section" class="mt-3" style="display: none;">
						        <h6 class="mb-3"><i class="fas fa-comments"></i> 결재 의견</h6>
						        <div id="approval-comments-list">
						            <!-- JavaScript로 동적 생성 -->
						        </div>
						    </div>
						</div>
					</div>
               
					<div id="modalError" style="display: none;" class="alert alert-danger">
					     <i class="fas fa-exclamation-triangle"></i>
					     결재 정보를 불러오는데 실패했습니다. 다시 시도해주세요.
					</div>
				</div>
				<div class="form-group mt-3">
				    <label for="modal-comments">결재 의견</label>
				    <textarea class="form-control" id="modal-comments" rows="3" 
				              placeholder="승인/반려 사유를 입력하세요 (선택사항)"></textarea>
				</div>
				<div class="modal-footer">
				    <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
				    <button type="button" class="btn btn-success" id="approveBtn" disabled>
				        <i class="fas fa-check"></i> 승인
				    </button>
				    <button type="button" class="btn btn-danger" id="rejectBtn" disabled>
				        <i class="fas fa-times"></i> 반려
				    </button>
				</div>
        	</div>
    	</div>
	</div>
</th:block>

<th:block layout:fragment="script">
<script th:inline="javascript">
// 전역 변수 및 상수
let currentReqId = null, isViewMode = false;

const REQ_TYPE_LABELS = {
    'BASIC': '기본',
    'VACATION': '휴가신청서',
    'SPENDING': '지출결의서'
};

const MODAL_FIELDS = {
    reqId: 'modal-reqId',
    reqType: 'modal-reqType',
    drafterName: 'modal-drafterName',
    department: 'modal-department',
    title: 'modal-title',
    content: 'modal-content-detail',
    createAt: 'modal-createAt'
};

const API_ENDPOINTS = {
    detail: reqId => `/approval/api/detail/${reqId}`,
    approve: reqId => `/approval/api/approve/${reqId}`,
    reject: reqId => `/approval/api/reject/${reqId}`,
    cancel: reqId => `/approval/api/cancel/${reqId}`
};

const STATUS_CLASSES = {
    '승인': 'approval-status-approved',
    '반려됨': 'approval-status-canceled'
};

// 모달 열기 통합 함수
function openModal(reqId, viewMode = false) {
    if (!reqId) {
        alert('결재 번호가 없습니다.');
        return;
    }
    
    currentReqId = reqId;
    isViewMode = viewMode;
    
    const commentsTextarea = document.getElementById('modal-comments');
    if (commentsTextarea) commentsTextarea.value = '';
    
    $('#approvalModal').modal('show');
    showModalState('modalLoading');
    
    fetch(API_ENDPOINTS.detail(reqId))
        .then(response => {
            if (!response.ok) throw new Error(`서버 응답 오류: ${response.status}`);
            return response.json();
        })
        .then(data => {
            displayModalContent(data);
        })
        .catch(error => {
            showModalState('modalError');
        });
}

window.openApprovalModal = reqId => openModal(reqId, false);
window.openViewApprovalModal = reqId => openModal(reqId, true);

// 결재 취소
function cancelApproval(reqId) {
    openModal(reqId, true);
    
    setTimeout(() => {
        if (confirm('이 결재를 취소하시겠습니까?\n취소된 결재는 완전히 삭제되며 복구할 수 없습니다.')) {
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            fetch(API_ENDPOINTS.cancel(reqId), {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    [header]: token
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.text();
            })
            .then(result => {
                alert('결재가 취소(삭제)되었습니다.');
                $('#approvalModal').modal('hide');
                location.reload();
            })
            .catch(error => {
                alert('결재 취소 중 오류가 발생했습니다.');
            });
        }
    }, 1000);
}

// 모달 상태 관리 통합
function showModalState(activeElement) {
    ['modalLoading', 'modalContent', 'modalError'].forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) {
            element.style.display = elementId === activeElement ? 'block' : 'none';
        }
    });
    
    if (activeElement === 'modalContent') {
        const approveBtn = document.getElementById('approveBtn');
        const rejectBtn = document.getElementById('rejectBtn');
        const commentsTextarea = document.getElementById('modal-comments');
        
        if (isViewMode) {
            if (approveBtn) approveBtn.style.display = 'none';
            if (rejectBtn) rejectBtn.style.display = 'none';
            if (commentsTextarea) commentsTextarea.disabled = true;
        } else {
            if (approveBtn) {
                approveBtn.style.display = 'inline-block';
                approveBtn.disabled = false;
            }
            if (rejectBtn) {
                rejectBtn.style.display = 'inline-block';
                rejectBtn.disabled = false;
            }
            if (commentsTextarea) {
                commentsTextarea.disabled = false;
                commentsTextarea.placeholder = "승인/반려 사유를 입력하세요 (선택사항)";
            }
        }
    } else {
        const approveBtn = document.getElementById('approveBtn');
        const rejectBtn = document.getElementById('rejectBtn');
        if (approveBtn) approveBtn.disabled = true;
        if (rejectBtn) rejectBtn.disabled = true;
    }
}

// 모달 내용 표시
function displayModalContent(data) {
    try {
        populateModalFields(data);
        displayApprovalLines(data.approvalLines);
        
        if (isViewMode && data.approvalLines) {
            displayExistingComments(data.approvalLines);
        }
        
     	// 인사발령일 경우에만 내용을 다르게 처리
        displayApprovalContent(data);
        
        showModalState('modalContent');
    } catch (error) {
        showModalState('modalError');
    }
}

// 0903 결재 콘텐츠 표시 함수 추가(지원영)
function displayApprovalContent(data) {
    const contentElement = document.getElementById('modal-content-detail');
    if (!contentElement) return;

    // 결재 타입이 인사발령이면 content에 아래 내용 표시
    if (data.reqType === 'TRANSFER') {
        try {
            const transferData = JSON.parse(data.content);
            const formattedContent = `
                <div class="card my-3">
                    <div class="card-body">
                        <p><strong>사원번호:</strong> ${transferData.empId || '-'}</p>
                        <p><strong>이름:</strong> ${transferData.name || '-'}</p>
                        <p><strong>발령타입:</strong> ${transferData.transType || '-'}</p>
                        <p><strong>발령일:</strong> ${transferData.transDate || '-'}</p>
                        <p><strong>부서:</strong> ${transferData.oldDeptName || '-'} -> ${transferData.newDeptName || '-'}</p>
                        <p><strong>직급:</strong> ${transferData.oldPosName || '-'} -> ${transferData.newPosName || '-'}</p>
                        <p><strong>발령 사유:</strong> ${transferData.transReason || '-'}</p>
                        <p><strong>결재자 사원번호:</strong> ${transferData.approverId || '-'}</p>
                    </div>
                </div>
            `;
            contentElement.innerHTML = formattedContent;
        } catch (e) {
            console.error("JSON 파싱 오류:", e);
            contentElement.textContent = "내용을 불러올 수 없습니다. (JSON 형식 오류)";
        }
    } else {
        // 인사발령이 아닐 경우, 기존처럼 텍스트를 그대로 표시
        contentElement.innerHTML = data.content || '-';
    }
}

// 기존 코멘트 표시
function displayExistingComments(approvalLines) {
    const commentsTextarea = document.getElementById('modal-comments');
    if (!commentsTextarea || !approvalLines) return;
    
    const currentUserId = /*[[${#authentication.name}]]*/ 'defaultUser';
    
    const myApproval = approvalLines.find(line => 
        line.apprId === currentUserId && 
        (line.decision === 'ACCEPT' || line.decision === 'DENY') && 
        line.comments && 
        line.comments.trim() !== ''
    );
    
    if (myApproval) {
        commentsTextarea.value = myApproval.comments;
    }
}

// 결재선 표시
function displayApprovalLines(approvalLines) {
    const tbody = document.getElementById('approval-line-tbody');
    if (!tbody) return;
    
    const drafterName = document.getElementById('modal-drafterName').textContent;
    const approverCount = approvalLines ? approvalLines.length : 0;
    
    // 헤더 업데이트
    for (let i = 1; i <= 3; i++) {
        const headerCell = document.getElementById(`approver-header-${i}`);
        if (headerCell) {
            if (i <= approverCount) {
                headerCell.textContent = `결재자`;
                headerCell.style.display = 'table-cell';
            } else {
                headerCell.style.display = 'none';
            }
        }
    }
    
    // 테이블 생성
    let nameRow = `<tr><td style="text-align: center;">${drafterName}</td>`;
    let statusRow = `<tr><td style="text-align: center;"><span class="badge badge-primary">기안올림</span></td>`;
    
    for (let i = 0; i < approverCount; i++) {
        const line = approvalLines[i];
        nameRow += `<td style="text-align: center;">${line.apprName || '-'}</td>`;
        
        const status = line.decision === 'ACCEPT' ? '승인완료' : 
                      line.decision === 'DENY' ? '반려' : '대기중';
        const color = line.decision === 'ACCEPT' ? '#28a745' : 
                     line.decision === 'DENY' ? '#dc3545' : '#ffc107';
        statusRow += `<td style="text-align: center;"><span style="font-size: 12px; color: ${color}; font-weight: bold;">${status}</span></td>`;
    }
    
    tbody.innerHTML = nameRow + '</tr>' + statusRow + '</tr>';
    
    displayApprovalComments(approvalLines);
}

// 모달 필드 채우기
function populateModalFields(data) {
    const empIdElement = document.getElementById('modal-empId');
    if (!empIdElement) {
        const hiddenDiv = document.createElement('div');
        hiddenDiv.id = 'modal-empId';
        hiddenDiv.style.display = 'none';
        hiddenDiv.textContent = data.empId;
        document.getElementById('modalContent').appendChild(hiddenDiv);
    } else {
        empIdElement.textContent = data.empId;
    }
    // 0901 공통양식 내용 추가
    Object.entries(MODAL_FIELDS).forEach(([key, elementId]) => {
        const element = document.getElementById(elementId);
        if (element) {
            if (key === 'content') {
                element.innerHTML = data[key] || '-';
            } else if (key === 'createAt' && data[key]) {
                element.textContent = new Date(data[key]).toLocaleDateString('ko-KR');
            } else if (key === 'reqType' && data[key]) {
                element.textContent = REQ_TYPE_LABELS[data[key]] || data[key];
            } else {
                element.textContent = data[key] || '-';
            }
        }
    });
}

// 승인/반려 처리
function processApproval(action, endpoint, successMessage) {
    const actionKorean = action === 'approve' ? '승인' : '반려';
    
    if (!confirm(`${actionKorean}하시겠습니까?`)) return;
    
    const commentsElement = document.getElementById('modal-comments');
    const comments = commentsElement ? commentsElement.value.trim() : '';
    
    if (action === 'reject' && !comments) {
        if (!confirm('반려 사유가 입력되지 않았습니다. 그래도 반려하시겠습니까?')) {
            return;
        }
    }
    
    const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
    
    fetch(endpoint, {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json',
            [header]: token
        },
        body: JSON.stringify({ comments })
    })
    .then(response => {
        if (!response.ok) throw new Error(`서버 응답 오류: ${response.status}`);
        return response.text();
    })
    .then(result => {
        alert(successMessage);
        $('#approvalModal').modal('hide');
        updateTableRow(currentReqId, actionKorean);
    })
    .catch(error => {
        alert(`${actionKorean} 처리 중 오류가 발생했습니다.`);
    });
}

// 테이블 업데이트
function updateTableRow(reqId, newStatus) {
    const tableRows = document.querySelectorAll('#dataTable tbody tr');
    
    tableRows.forEach(row => {
        const approveButton = row.querySelector(`button[data-req-id="${reqId}"]`);
        
        if (approveButton) {
            // 상태 업데이트
            const statusCell = row.querySelector('td:nth-child(8) span');
            if (statusCell) {
                statusCell.textContent = newStatus;
                statusCell.className = `approval-status-badge ${STATUS_CLASSES[newStatus] || ''}`;
            }
            
            // 날짜 업데이트
            const dateCell = row.querySelector('td:nth-child(7)');
            if (dateCell) {
                const today = new Date();
                dateCell.textContent = today.getFullYear() + '-' + 
                                     String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                                     String(today.getDate()).padStart(2, '0');
            }
            
            // 버튼 업데이트
            const actionCell = row.querySelector('td:nth-child(9)');
            if (actionCell) {
                actionCell.innerHTML = `<button type="button" class="btn btn-info btn-sm view-approval-btn" data-req-id="${reqId}">결재확인</button>`;
            }
        }
    });
}

// 결재 의견 표시
function displayApprovalComments(approvalLines) {
    const commentsSection = document.getElementById('approval-comments-section');
    const commentsList = document.getElementById('approval-comments-list');
    
    if (!approvalLines || approvalLines.length === 0) {
        commentsSection.style.display = 'none';
        return;
    }
    
    let hasComments = false;
    let commentsHtml = '';
    
    approvalLines.forEach((line, index) => {
        if (line.comments && line.comments.trim() !== '') {
            hasComments = true;
            const status = line.decision === 'ACCEPT' ? '승인' : 
                          line.decision === 'DENY' ? '반려' : '대기';
            const statusClass = line.decision === 'ACCEPT' ? 'success' : 
                               line.decision === 'DENY' ? 'danger' : 'warning';
            
            let dateStr = '';
            if (line.decDate) {
                try {
                    const date = new Date(line.decDate);
                    dateStr = date.toLocaleDateString('ko-KR') + ' ' + 
                             date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                } catch {}
            }
            
            commentsHtml += `
                <div class="card mb-2">
                    <div class="card-header py-2 bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>결재자: ${line.apprName}</strong>
                                <span class="badge badge-${statusClass} ml-2">${status}</span>
                            </div>
                            <small class="text-muted">${dateStr}</small>
                        </div>
                    </div>
                    <div class="card-body py-2">
                        <p class="mb-0">${line.comments}</p>
                    </div>
                </div>
            `;
        }
    });
    
    if (hasComments) {
        commentsList.innerHTML = commentsHtml;
        commentsSection.style.display = 'block';
    } else {
        commentsSection.style.display = 'none';
    }
}

// 검색 기능
function searchByDrafter(searchTerm) {
    const normalizedSearchTerm = searchTerm.trim().toLowerCase();
    const tableRows = document.querySelectorAll('#dataTable tbody tr');
    
    tableRows.forEach(row => {
        const drafterCell = row.querySelector('.drafter-name');  
        if (drafterCell) {
            const drafterName = drafterCell.textContent.trim().toLowerCase();
            row.style.display = drafterName.includes(normalizedSearchTerm) ? '' : 'none';
        }
    });
}

// ===== 체크박스 삭제 기능 추가 =====

// 삭제 버튼 표시/숨김
function toggleDeleteButton() {
    const checked = document.querySelectorAll('.row-checkbox:checked');
    const deleteBtn = document.getElementById('deleteBtn');
    if (deleteBtn) {
        deleteBtn.style.display = checked.length > 0 ? 'block' : 'none';
    }
}

// 다중 삭제 실행
function deleteSelectedApprovals() {
    const checked = document.querySelectorAll('.row-checkbox:checked');
    if (checked.length === 0) {
        alert('삭제할 항목을 선택해주세요.');
        return;
    }
    
    // 비활성화된 체크박스가 선택되었는지 확인
    const disabledChecked = document.querySelectorAll('.row-checkbox:checked:disabled');
    if (disabledChecked.length > 0) {
        alert('삭제할 수 없는 항목이 선택되었습니다.\n본인이 기안한 완료된 결재만 삭제 가능합니다.');
        return;
    }
    
    if (!confirm(checked.length + '건을 삭제하시겠습니까?\n삭제된 결재는 복구할 수 없습니다.')) return;
    
    const ids = Array.from(checked).map(cb => cb.value);
    const formData = new FormData();
    ids.forEach(id => formData.append('ids', id));
    
    // CSRF 토큰 추가
    const token = document.querySelector('meta[name="_csrf"]').content;
    const header = document.querySelector('meta[name="_csrf_header"]').content;
    
    // 삭제 버튼 비활성화
    const deleteBtn = document.getElementById('deleteBtn');
    if (deleteBtn) {
        deleteBtn.disabled = true;
        deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 삭제 중...';
    }
    
    fetch('/approval/api/delete-selected', {
        method: 'POST',
        headers: { [header]: token },
        body: formData
    })
    .then(response => response.text())
    .then(result => {
        // 부분 성공/실패 메시지 처리
        if (result.includes('실패한 항목')) {
            // 부분 실패인 경우
            alert('일부 항목 삭제 완료:\n\n' + result);
        } else {
            // 전체 성공인 경우
            alert(result);
        }
        location.reload();
    })
    .catch(error => {
        alert('삭제 중 오류가 발생했습니다: ' + error);
    })
    .finally(() => {
        // 버튼 상태 복원
        if (deleteBtn) {
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i> 선택 삭제';
        }
    });
}

// 이벤트 리스너 등록
document.addEventListener('DOMContentLoaded', function() {
    // 기존 클릭 이벤트 위임
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('approval-btn')) {
            openModal(e.target.getAttribute('data-req-id'), false);
        } else if (e.target.classList.contains('view-approval-btn')) {
            openModal(e.target.getAttribute('data-req-id'), true);
        } else if (e.target.classList.contains('cancel-approval-btn')) {
            cancelApproval(e.target.getAttribute('data-req-id'));
        }
    });
    
    // 승인/반려 버튼
    const approveBtn = document.getElementById('approveBtn');
    if (approveBtn) {
        approveBtn.addEventListener('click', () => {
            processApproval('approve', API_ENDPOINTS.approve(currentReqId), '승인되었습니다!');
        });
    }
    
    const rejectBtn = document.getElementById('rejectBtn');
    if (rejectBtn) {
        rejectBtn.addEventListener('click', () => {
            processApproval('reject', API_ENDPOINTS.reject(currentReqId), '반려되었습니다!');
        });
    }
    
    // 검색 기능
    const searchButton = document.getElementById('searchButton');
    const drafterNameInput = document.getElementById('drafterNameInput');
    
    if (searchButton && drafterNameInput) {
        searchButton.addEventListener('click', () => searchByDrafter(drafterNameInput.value));
        drafterNameInput.addEventListener('keydown', event => {
            if (event.key === 'Enter') searchByDrafter(drafterNameInput.value);
        });
    }
    
    // 전체 선택 체크박스
	const selectAll = document.getElementById('selectAll');
	if (selectAll) {
	    selectAll.addEventListener('change', function() {
	        // 비활성화되지 않은 체크박스만 선택/해제
	        const checkboxes = document.querySelectorAll('.row-checkbox:not(:disabled)');
	        checkboxes.forEach(cb => cb.checked = this.checked);
	        toggleDeleteButton();
	    });
	}
    
    // 개별 체크박스 변경 시
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('row-checkbox')) {
            toggleDeleteButton();
        }
    });
    
    // 삭제 버튼 클릭
    const deleteBtn = document.getElementById('deleteBtn');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', deleteSelectedApprovals);
    }
    
    // 모달 닫힐 때 초기화
    $('#approvalModal').on('hidden.bs.modal', function () {
        const approveBtn = document.getElementById('approveBtn');
        const rejectBtn = document.getElementById('rejectBtn');
        const commentsTextarea = document.getElementById('modal-comments');
        
        if (approveBtn) {
            approveBtn.style.display = 'inline-block';
            approveBtn.disabled = true;
        }
        if (rejectBtn) {
            rejectBtn.style.display = 'inline-block';
            rejectBtn.disabled = true;
        }
        if (commentsTextarea) {
            commentsTextarea.disabled = false;
        }
        
        isViewMode = false;
    });
});
</script>
</th:block>
</body>
</html>