<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<style>
.table td, .table th {
    padding: 0.5rem;
    vertical-align: middle;
}
.edit-mode {
    background-color: #fff3cd !important;
}
</style>
</head>

<body>
<th:block layout:fragment="content">
    <div class="container-fluid">
        <h1 class="h3 mb-4 text-gray-800">제품(완/반) 관리</h1>
        
        <!-- 검색 영역 -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <form id="searchForm">
                    <div class="row">
                        <div class="col-md-2">
                            <select class="form-control" id="productCategory">
                                <option value="">제품구분 전체</option>
                                <!-- 추후 협의 후 추가 -->
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-control" id="productType">
                                <option value="">제품유형 전체</option>
                                <option value="반제품">반제품</option>
                                <option value="완제품">완제품</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="searchKeyword" 
                                   placeholder="제품코드 또는 제품명">
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-primary" onclick="searchProduct()">검색</button>
                            <button type="button" class="btn btn-secondary" onclick="resetSearch()">초기화</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 제품 테이블 -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">제품 목록</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered text-center">
                        <thead class="thead-light">
                            <tr>
                                <th width="3%">
                                    <input type="checkbox" id="selectAll">
                                </th>
                                <th width="10%">제품코드</th>
                                <th width="18%">제품명</th>
                                <th width="10%">제품구분</th>
                                <th width="8%">제품유형</th>
                                <th width="6%">단위</th>
                                <th width="12%">가격</th>
                                <th width="10%">등록자</th>
                                <th width="12%">등록일</th>
                            </tr>
                        </thead>
                        <tbody id="productTableBody">
                        </tbody>
                    </table>
                </div>
                <div>
                    <button class="btn btn-success btn-sm" onclick="showAddRow()">
                        <i class="fas fa-plus"></i> 추가
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="toggleEditMode()">
                        <i class="fas fa-edit"></i> 수정
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteSelected()">
                        <i class="fas fa-trash"></i> 삭제
                    </button>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="script">
<script>
// 전역 변수
let productData = [];
let currentUserId = '';
let currentEditRow = null;

// 페이지 로드시 실행
$(document).ready(function() {
    loadProducts();
    getCurrentUser();
    
    $('#selectAll').on('change', function() {
        $('.item-check').prop('checked', $(this).is(':checked'));
    });
});

// 현재 로그인 사용자 정보 조회
function getCurrentUser() {
    $.ajax({
        url: '/api/current-user',
        type: 'GET',
        success: function(data) {
            currentUserId = data.empId;
        }
    });
}

// 데이터 조회
function loadProducts() {
    const params = {
        productType: $('#productType').val(),
        searchKeyword: $('#searchKeyword').val()
    };
    
    $.ajax({
        url: '/api/inventory/products',
        type: 'GET',
        data: params,
        success: function(data) {
            productData = data;
            displayProducts(data);
        },
        error: function() {
            alert('데이터 조회 실패');
        }
    });
}

function displayProducts(data) {
    const tbody = $('#productTableBody');
    tbody.empty();
    
    if(data.length === 0) {
        tbody.append('<tr><td colspan="9">데이터가 없습니다.</td></tr>');
        return;
    }
    
    data.forEach(item => {
        tbody.append(createTableRow(item));
    });
}

function createTableRow(item) {
    const typeColor = item.productType === '완제품' ? 'text-primary' : 'text-warning';
    const formattedPrice = item.price ? 
        new Intl.NumberFormat('ko-KR').format(item.price) + '원' : '-';
    
    return `
        <tr data-id="${item.productId}">
            <td><input type="checkbox" class="item-check" value="${item.productId}"></td>
            <td>${item.productId}</td>
            <td>${item.productName}</td>
            <td>-</td>
            <td>
                <span class="badge badge-light ${typeColor}" style="font-size: 12px;">
                    ${item.productType}
                </span>
            </td>
            <td>${item.unit}</td>
            <td class="text-right">${formattedPrice}</td>   
            <td>${item.empId || '-'}</td>
            <td>${formatDate(item.createdAt)}</td>
        </tr>
    `;
}

// 검색
function searchProduct() {
    loadProducts();
}

function resetSearch() {
    $('#productCategory').val('');
    $('#productType').val('');
    $('#searchKeyword').val('');
    loadProducts();
}

// 수정
function toggleEditMode() {
    const checked = $('.item-check:checked');
    
    if(checked.length === 0) {
        alert('수정할 항목을 선택해주세요.');
        return;
    }
    
    if(checked.length > 1) {
        alert('한 번에 하나의 항목만 수정할 수 있습니다.');
        return;
    }
    
    if(currentEditRow) {
        alert('현재 수정 중인 항목을 먼저 저장하거나 취소해주세요.');
        return;
    }
    
    const row = checked.closest('tr');
    currentEditRow = row.data('id');
    enableEditMode(row);
}

function enableEditMode(row) {
    row.addClass('edit-mode');
    
    const productName = row.find('td:eq(2)').text();
    const productType = row.find('td:eq(4) span').text().trim();
    const unit = row.find('td:eq(5)').text();
    const spec = row.find('td:eq(6)').text();
    
    row.find('td:eq(2)').html(`<input type="text" class="form-control form-control-sm" value="${productName}">`);
    row.find('td:eq(4)').html(`
        <select class="form-control form-control-sm">
            <option value="반제품" ${productType === '반제품' ? 'selected' : ''}>반제품</option>
            <option value="완제품" ${productType === '완제품' ? 'selected' : ''}>완제품</option>
        </select>
    `);
    row.find('td:eq(5)').html(`<input type="text" class="form-control form-control-sm" value="${unit}">`);
    row.find('td:eq(6)').html(`<input type="text" class="form-control form-control-sm" value="${spec === '-' ? '' : spec}">`);
    
    row.find('td:eq(8)').html(`
        <button class="btn btn-sm btn-success" onclick="saveRow('${row.data('id')}')">저장</button>
        <button class="btn btn-sm btn-danger" onclick="cancelEdit()">취소</button>
    `);
}

function saveRow(productId) {
    const row = $(`tr[data-id="${productId}"]`);
    const priceValue = row.find('td:eq(6) input').val();
    
    const updateData = {
        productId: productId,
        productName: row.find('td:eq(2) input').val(),
        productType: row.find('td:eq(4) select').val(),
        unit: row.find('td:eq(5) input').val(),
        price: priceValue ? parseInt(priceValue) : 0,  // null 대신 0
        empId: currentUserId
    };
    
    ajaxCall('PUT', `/api/inventory/products/${productId}`, updateData, 
        () => {
            alert('수정 완료');
            currentEditRow = null;
            loadProducts();
        },
        () => alert('수정 실패')
    );
}

function cancelEdit() {
    currentEditRow = null;
    loadProducts();
}

// 추가
function showAddRow() {
    if($('#newRow').length > 0) {
        alert('이미 추가 중입니다.');
        return;
    }
    
    if(currentEditRow) {
        alert('현재 수정 중인 항목을 먼저 저장하거나 취소해주세요.');
        return;
    }
    
    const newRow = `
        <tr id="newRow" class="table-warning">
            <td><input type="checkbox" disabled></td>
            <td><input type="text" class="form-control form-control-sm" id="new_productId" placeholder="제품코드"></td>
            <td><input type="text" class="form-control form-control-sm" id="new_productName" placeholder="제품명"></td>
            <td>-</td>
            <td>
                <select class="form-control form-control-sm" id="new_productType">
                    <option value="반제품">반제품</option>
                    <option value="완제품">완제품</option>
                </select>
            </td>
            <td><input type="text" class="form-control form-control-sm" id="new_unit" placeholder="단위"></td>
           	<td><input type="number" class="form-control form-control-sm text-right" id="new_price" placeholder="가격"></td>
            <td>${currentUserId || '로딩중...'}</td>
            <td>
                <button class="btn btn-sm btn-success" onclick="saveProduct()">저장</button>
                <button class="btn btn-sm btn-danger" onclick="cancelAdd()">취소</button>
            </td>
        </tr>
    `;
    
    $('#productTableBody').prepend(newRow);
}

function saveProduct() {
    const newProduct = {
        productId: $('#new_productId').val(),
        productName: $('#new_productName').val(),
        productType: $('#new_productType').val(),
        unit: $('#new_unit').val(),
        price: $('#new_price').val() ? parseInt($('#new_price').val()) : 0,  
        empId: currentUserId
    };
    
    console.log('전송 데이터:', newProduct);  
    
    ajaxCall('POST', '/api/inventory/products', newProduct,
        (result) => {
            if(result.success) {
                alert('등록 완료');
                $('#newRow').remove();
                loadProducts();
            }
        }
    );
}

function cancelAdd() {
    $('#newRow').remove();
}

// 삭제
function deleteSelected() {
    const checked = $('.item-check:checked');
    if(checked.length === 0) {
        alert('삭제할 항목을 선택해주세요.');
        return;
    }
    
    if(confirm(checked.length + '개 항목을 삭제하시겠습니까?')) {
        const ids = checked.map(function() { return $(this).val(); }).get();
        
        ajaxCall('DELETE', '/api/inventory/products', ids,
            (result) => {
                if(result.success) {
                    alert('삭제 완료');
                    loadProducts();
                } else {
                    alert(result.message || '삭제 실패');
                }
            }
        );
    }
}

function ajaxCall(method, url, data, successCallback, errorCallback) {
    $.ajax({
        url: url,
        type: method,
        contentType: 'application/json',
        data: JSON.stringify(data),
        headers: {
            'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
        },
        success: successCallback,
        error: errorCallback || function() { alert('처리 실패'); }
    });
}

function formatDate(dateStr) {
    if(!dateStr) return '-';
    return new Date(dateStr).toLocaleDateString('ko-KR');
}
</script>
</th:block>
</body>
</html>