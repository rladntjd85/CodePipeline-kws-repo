<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>

<body>
<th:block layout:fragment="content">
    <div class="container-fluid">
        <h1 class="h3 mb-4 text-gray-800">자재(부품/반제품) 관리</h1>
        
        <!-- 검색 영역 -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <form id="searchForm">
                    <div class="row">
                        <div class="col-md-2">
                            <select class="form-control" id="materialType">
                                <option value="">자재구분 전체</option>
                                <option value="부품">부품</option>
                                <option value="반제품">반제품</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="searchKeyword" 
                                   placeholder="자재코드 또는 자재명">
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-primary" onclick="searchMaterial()">검색</button>
                            <button type="button" class="btn btn-secondary" onclick="resetSearch()">초기화</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 자재 테이블 -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">자재 목록</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered text-center">
                        <thead class="thead-light">
						    <tr>
						        <th width="3%"><input type="checkbox" id="selectAll"></th>
						        <th width="10%">자재코드</th>
						        <th width="15%">자재명</th>
						        <th width="8%">자재유형</th>
						        <th width="5%">단위</th>
						        <th width="15%">자재 사양</th>
						        <th width="8%">단가</th>
						        <th width="12%">검사방법</th>
						        <th width="8%">등록자</th>
						        <th width="8%">등록일</th>
						    </tr>
						</thead>
                        <tbody id="materialTableBody">
                        </tbody>
                    </table>
                    <div>
                        <button class="btn btn-success btn-sm" onclick="showAddRow()">
                            <i class="fas fa-plus"></i> 추가
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="toggleEditMode()">
                            <i class="fas fa-edit"></i> 수정
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteSelected()">
                            <i class="fas fa-trash"></i> 삭제
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="script">
<script>
let materialData = [];
let currentUserId = '';
let currentEditRow = null;
let materialTypes = []; // 공통코드에서 가져올 자재타입
let inspectionMethods = [];
let unitList = [];		// 공통코드에서 가져올 단위타입


$(document).ready(function() {
    loadMaterialTypes(); 
    getCurrentUser();
    loadInspectionMethods();
    loadUnitList(); 
    
    setTimeout(function() { loadMaterials(); }, 500);
    
    $('#selectAll').on('change', function() {
        $('.item-check').prop('checked', $(this).is(':checked'));
    });
});

//단위 목록 로드
function loadUnitList() {
    $.ajax({
        url: '/api/inventory/units',
        type: 'GET',
        success: function(data) {
            console.log("단위 목록 로드 성공:", data);
            unitList = data;
        },
        error: function(xhr) {
            console.error("단위 목록 로드 실패:", xhr);
        }
    });
}

function loadMaterialTypes() {
    console.log("loadMaterialTypes 시작");
    
    // API 호출 없이 직접 데이터 설정
    materialTypes = [
        {code: 'PTYPE003', name: '부품'},
        {code: 'PTYPE002', name: '반제품'}
    ];
    
    const select = $('#materialType');
    select.empty();
    select.append('<option value="">자재구분 전체</option>');
    
    materialTypes.forEach(item => {
        select.append(`<option value="${item.name}">${item.name}</option>`);
    });
    
    console.log("materialTypes 설정 완료:", materialTypes);
}

// 현재 로그인 사용자
function getCurrentUser() {
    $.ajax({
        url: '/api/current-user',
        type: 'GET',
        success: function(data) {
            currentUserId = data.empId;
        }
    });
}

// 자재 목록 조회
function loadMaterials() {
    const params = {
        materialType: $('#materialType').val(),
        searchKeyword: $('#searchKeyword').val()
    };
    
    $.ajax({
        url: '/api/inventory/materials',
        type: 'GET',
        data: params,
        success: function(data) {
            materialData = data;
            displayMaterials(data);
        },
        error: function() {
            alert('데이터 조회 실패');
        }
    });
}

function displayMaterials(data) {
    const tbody = $('#materialTableBody');
    tbody.empty();
    
    if(data.length === 0) {
        tbody.append('<tr><td colspan="9">데이터가 없습니다.</td></tr>');
        return;
    }
    
    data.forEach(item => {
        tbody.append(createTableRow(item));
    });
}

function createTableRow(item) {
    const typeColor = item.materialType === '부품' ? 'text-info' : 'text-warning';
    const price = item.price ? new Intl.NumberFormat('ko-KR').format(item.price) + '원' : '-';
    const inspectionMethod = item.inspectionItemName || '-';
    
    // unit 코드로 unitList에서 이름 찾기
    let unitDisplay = item.unit;
    if(unitList && unitList.length > 0) {
        const unitItem = unitList.find(u => u.code === item.unit);
        if(unitItem) {
            unitDisplay = unitItem.name;
        }
    }
    
    return `
        <tr data-id="${item.materialId}">
            <td><input type="checkbox" class="item-check" value="${item.materialId}"></td>
            <td>${item.materialId}</td>
            <td>${item.materialName}</td>
            <td><span class="badge badge-light ${typeColor}" style="font-size: 14px;">${item.materialType || item.materialTypeName}</span></td>
            <td>${unitDisplay}</td>  
            <td>${item.spec || '-'}</td>
            <td class="text-right">${price}</td>
            <td>${inspectionMethod}</td>
            <td>${item.empId || '-'}</td>
            <td>${formatDate(item.createdAt)}</td>
        </tr>
    `;
}

// 검색
function searchMaterial() {
    loadMaterials();
}

function resetSearch() {
    $('#materialType').val('');
    $('#searchKeyword').val('');
    loadMaterials();
}

// ========== 수정 관련 ==========
function toggleEditMode() {
    const checked = $('.item-check:checked');
    
    if(checked.length === 0) {
        alert('수정할 항목을 선택해주세요.');
        return;
    }
    
    if(checked.length > 1) {
        alert('한 번에 하나의 항목만 수정할 수 있습니다.');
        return;
    }
    
    if(currentEditRow) {
        alert('현재 수정 중인 항목을 먼저 저장하거나 취소해주세요.');
        return;
    }
    
    const row = checked.closest('tr');
    currentEditRow = row.data('id');
    enableEditMode(row);
}

function enableEditMode(row) {
    row.addClass('edit-mode bg-warning');
    
    // 각 필드값 가져오기
    const materialName = row.find('td:eq(2)').text();
    const currentType = row.find('td:eq(3) span').text();
    const unit = row.find('td:eq(4)').text();
    const spec = row.find('td:eq(5)').text();
    const price = row.find('td:eq(6)').text().replace(/[^0-9]/g, '');
    
    // 공통코드로 select 만들기
    const typeOptions = materialTypes.map(t => 
        `<option value="${t.name}" ${t.name === currentType ? 'selected' : ''}>${t.name}</option>`
    ).join('');
    
    // input으로 변경
    row.find('td:eq(2)').html(`<input type="text" class="form-control form-control-sm" value="${materialName}">`);
    row.find('td:eq(3)').html(`
        <select class="form-control form-control-sm">
            ${typeOptions}
        </select>
    `);
    row.find('td:eq(4)').html(`<input type="text" class="form-control form-control-sm" value="${unit}">`);
    row.find('td:eq(5)').html(`<input type="text" class="form-control form-control-sm" value="${spec === '-' ? '' : spec}">`);
    row.find('td:eq(6)').html(`<input type="number" class="form-control form-control-sm" value="${price || ''}">`);
    
    // 버튼 추가
    const originalDate = row.find('td:eq(8)').text();
    row.find('td:eq(8)').html(`
        <button class="btn btn-sm btn-success" onclick="saveRow('${row.data('id')}')">저장</button>
        <button class="btn btn-sm btn-danger" onclick="cancelEdit()">취소</button>
    `);
}

function saveRow(materialId) {
    const row = $(`tr[data-id="${materialId}"]`);
    const updateData = {
        materialId: materialId,
        materialName: row.find('td:eq(2) input').val(),
        materialType: row.find('td:eq(3) select').val(),
        unit: row.find('td:eq(4) input').val(),
        spec: row.find('td:eq(5) input').val(),
        price: row.find('td:eq(6) input').val(),
        empId: currentUserId
    };
    
    // 유효성 검사
    if(!updateData.materialName || !updateData.unit) {
        alert('자재명과 단위는 필수 입력 항목입니다.');
        return;
    }
    
    ajaxCall('PUT', `/api/inventory/materials/${materialId}`, updateData, 
        () => {
            alert('수정 완료');
            currentEditRow = null;
            loadMaterials();
        },
        () => alert('수정 실패')
    );
}

function cancelEdit() {
    currentEditRow = null;
    loadMaterials();
}

// ========== 추가 관련 ==========
// showAddRow 함수 수정
function showAddRow() {
    if($('#newRow').length > 0) {
        alert('이미 추가 중입니다.');
        return;
    }
    
    const typeOptions = materialTypes.map(t => 
        `<option value="${t.name}">${t.name}</option>`
    ).join('');
    
    // 검사방법 옵션
    let inspectionOptions = '<option value="">선택</option>';
    if(inspectionMethods && inspectionMethods.length > 0) {
        inspectionOptions += inspectionMethods.map(m => 
            `<option value="${m.inspectionFmId}">${m.itemName}</option>`
        ).join('');
    }
    
    // 단위 옵션 추가
    let unitOptions = '';
    if(unitList && unitList.length > 0) {
        unitOptions = unitList.map(u => 
            `<option value="${u.code}">${u.name}</option>`
        ).join('');
    }
    
    const newRow = `
        <tr id="newRow" class="table-warning">
            <td><input type="checkbox" disabled></td>
            <td><input type="text" class="form-control form-control-sm" id="new_materialId" placeholder="자재코드"></td>
            <td><input type="text" class="form-control form-control-sm" id="new_materialName" placeholder="자재명"></td>
            <td>
                <select class="form-control form-control-sm" id="new_materialType">
                    ${typeOptions}
                </select>
            </td>
            <td>
                <select class="form-control form-control-sm" id="new_unit">
                    ${unitOptions}
                </select>
            </td>
            <td><input type="text" class="form-control form-control-sm" id="new_spec" placeholder="사양"></td>
            <td><input type="number" class="form-control form-control-sm" id="new_price" placeholder="단가"></td>
            <td>
                <select class="form-control form-control-sm" id="new_inspectionFmId">
                    ${inspectionOptions}
                </select>
            </td>
            <td>${currentUserId || '로딩중...'}</td>
            <td>
                <button class="btn btn-sm btn-success" onclick="saveMaterial()">저장</button>
                <button class="btn btn-sm btn-danger" onclick="cancelAdd()">취소</button>
            </td>
        </tr>
    `;
    
    $('#materialTableBody').prepend(newRow);
}

function saveMaterial() {
    const newMaterial = {
        materialId: $('#new_materialId').val(),
        materialName: $('#new_materialName').val(),
        materialType: $('#new_materialType').val(),
        unit: $('#new_unit').val(),
        spec: $('#new_spec').val(),
        price: $('#new_price').val(),
        inspectionFmId: $('#new_inspectionFmId').val(), // 추가
        empId: currentUserId
    };
    
    // 유효성 검사
    if(!newMaterial.materialId || !newMaterial.materialName || !newMaterial.unit) {
        alert('자재코드, 자재명, 단위는 필수 입력 항목입니다.');
        return;
    }
    
    // inspection_fm_id가 필수인지 확인
    if(!newMaterial.inspectionFmId) {
        if(!confirm('검사방법을 선택하지 않았습니다. 계속하시겠습니까?')) {
            return;
        }
    }
    
    ajaxCall('POST', '/api/inventory/materials', newMaterial,
        (result) => {
            if(result.success) {
                alert('등록 완료');
                $('#newRow').remove();
                loadMaterials();
            } else {
                alert(result.message);
            }
        }
    );
}

function cancelAdd() {
    $('#newRow').remove();
}

// ========== 삭제 관련 ==========
function deleteSelected() {
    const checked = $('.item-check:checked');
    if(checked.length === 0) {
        alert('삭제할 항목을 선택해주세요.');
        return;
    }
    
    if(confirm(checked.length + '개 항목을 삭제하시겠습니까?')) {
        const ids = checked.map(function() { return $(this).val(); }).get();
        
        ajaxCall('DELETE', '/api/inventory/materials', ids,
            (result) => {
                if(result.success) {
                    alert('삭제 완료');
                    loadMaterials();
                } else {
                    alert(result.message || '삭제 실패');
                }
            }
        );
    }
}

function loadInspectionMethods() {
    console.log("검사방법 로드 시작");
    $.ajax({
        url: '/api/inventory/inspection-methods',
        type: 'GET',
        success: function(data) {
            console.log("검사방법 로드 성공:", data);
            inspectionMethods = data;
        },
        error: function(xhr, status, error) {
            console.error("검사방법 로드 실패:", error);
            console.error("상태:", status);
            console.error("응답:", xhr.responseText);
        }
    });
}


// ========== 공통 함수 ==========
function ajaxCall(method, url, data, successCallback, errorCallback) {
    $.ajax({
        url: url,
        type: method,
        contentType: 'application/json',
        data: JSON.stringify(data),
        headers: {
            'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
        },
        success: successCallback,
        error: errorCallback || function() { alert('처리 실패'); }
    });
}

function formatDate(dateStr) {
    if(!dateStr) return '-';
    return new Date(dateStr).toLocaleDateString('ko-KR');
}
</script>
</th:block>
</body>
</html>