<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">

<head>
<meta name="_csrf" th:content="${_csrf.token}"/>
<meta name="_csrf_header" th:content="${_csrf.headerName}"/>
<style>
.table td, .table th {
    padding: 0.5rem;
    vertical-align: middle;
    font-size: 0.9rem;
}
.edit-mode {
    background-color: #fff3cd !important;
}
</style>
</head>

<body>
<th:block layout:fragment="content">
    <div class="container-fluid">
        <h1 class="h3 mb-4 text-gray-800">창고 정보 관리</h1>
        
        <!-- 검색 영역 -->
        <div class="card shadow mb-4">
            <div class="card-body">
                <form>
                    <div class="row">
                        <div class="col-md-2">
                            <select class="form-control" id="warehouseType">
                                <option value="">창고유형 전체</option>
                                <option value="원자재">원자재</option>
                                <option value="반제품">반제품</option>
                                <option value="완제품">완제품</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-control" id="warehouseStatus">
                                <option value="">운영상태 전체</option>
                                <option value="Y">운영중</option>
                                <option value="N">운영중지</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="searchKeyword" placeholder="창고ID 또는 창고명">
                        </div>
                        <div class="col-md-3">
                            <button type="button" class="btn btn-primary" onclick="searchWarehouse()">검색</button>
                            <button type="button" class="btn btn-secondary" onclick="resetSearch()">초기화</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 창고 테이블 -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">창고 목록</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered text-center">
                        <thead class="thead-light">
                            <tr>
                                <th width="3%">
                                    <input type="checkbox" id="selectAll">
                                </th>
                                <th width="8%">창고ID</th>
                                <th width="12%">창고명</th>
                                <th width="8%">창고유형</th>
                                <th width="8%">운영상태</th>
                                <th width="15%">창고위치</th>
                                <th width="8%">담당자</th>
                                <th width="20%">비고</th>
                                <th width="10%">생성일</th>
                            </tr>
                        </thead>
                        <tbody id="warehouseTableBody">
                        </tbody>
                    </table>
                </div>
            	<div>
                    <button class="btn btn-success btn-sm" onclick="showAddRow()">
                        <i class="fas fa-plus"></i> 추가
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="toggleEditMode()">
                        <i class="fas fa-edit"></i> 수정
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="deleteSelected()">
                        <i class="fas fa-trash"></i> 삭제
                    </button>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block layout:fragment="script">
<script>
// 전역 변수
let warehouseData = [];
let currentUserId = '';
let currentEditRow = null;

$(document).ready(function() {
    loadWarehouses();
    getCurrentUser();
    loadWarehouseTypes();
    
    $('#selectAll').on('change', function() {
        $('.item-check').prop('checked', $(this).is(':checked'));
    });
});

// 현재 사용자 조회
function getCurrentUser() {
    $.ajax({
        url: '/api/current-user',
        type: 'GET',
        success: function(data) {
            currentUserId = data.empId;
        }
    });
}

// 창고 목록 조회
function loadWarehouses() {
    const params = {
        warehouseType: $('#warehouseType').val(),
        warehouseStatus: $('#warehouseStatus').val(),
        searchKeyword: $('#searchKeyword').val()
    };
    
    $.ajax({
        url: '/inventory/api/warehouses', 
        type: 'GET',
        data: params,
        success: function(data) {
            warehouseData = data;
            displayWarehouses(data);
        },
        error: function() {
            alert('데이터 조회 실패');
        }
    });
}

function displayWarehouses(data) {
    const tbody = $('#warehouseTableBody');
    tbody.empty();
    
    if(data.length === 0) {
        tbody.append('<tr><td colspan="9">데이터가 없습니다.</td></tr>');
        return;
    }
    
    data.forEach(item => {
        tbody.append(createTableRow(item));
    });
}

function createTableRow(item) {
    const typeColor = getTypeColor(item.warehouseType);
    const statusBadge = item.warehouseStatus === 'Y' 
        ? '<span class="badge badge-success">운영중</span>'
        : '<span class="badge badge-danger">운영중지</span>';
    
    return `
        <tr data-id="${item.warehouseId}">
            <td><input type="checkbox" class="item-check" value="${item.warehouseId}"></td>
            <td>${item.warehouseId}</td>
            <td>${item.warehouseName}</td>
            <td><span class="badge ${typeColor}" style="font-size: 12px;">${item.warehouseType}</span></td>
            <td>${statusBadge}</td>
            <td>${item.warehouseLocation || '-'}</td>
            <td>${item.empId || '-'}</td>
            <td class="text-left">${item.description || '-'}</td>
            <td>${formatDate(item.createDate)}</td>
        </tr>
    `;
}

// 검색
function searchWarehouse() {
    loadWarehouses();
}

function resetSearch() {
    $('#warehouseType').val('');
    $('#warehouseStatus').val('');
    $('#searchKeyword').val('');
    loadWarehouses();
}

// 수정
function toggleEditMode() {
    const checked = $('.item-check:checked');
    
    if(checked.length === 0) {
        alert('수정할 창고를 선택해주세요.');
        return;
    }
    
    if(checked.length > 1) {
        alert('한 번에 하나의 창고만 수정할 수 있습니다.');
        return;
    }
    
    if(currentEditRow) {
        alert('현재 수정 중인 항목을 먼저 저장하거나 취소해주세요.');
        return;
    }
    
    const row = checked.closest('tr');
    currentEditRow = row.data('id');
    enableEditMode(row);
}

function enableEditMode(row) {
    row.addClass('edit-mode');
    
    const warehouseName = row.find('td:eq(2)').text();
    const warehouseType = row.find('td:eq(3) span').text();
    const warehouseStatus = row.find('td:eq(4) span').text() === '운영중' ? 'Y' : 'N';
    const warehouseLocation = row.find('td:eq(5)').text();
    const currentEmpId = row.find('td:eq(6)').text();  // 현재 담당자 ID
    const description = row.find('td:eq(7)').text();
    
    $.ajax({
        url: '/api/employees',
        type: 'GET',
        async: false,  
        success: function(employees) {
            const employeeOptions = employees.map(emp => 
                `<option value="${emp.empId}" ${emp.empId === currentEmpId ? 'selected' : ''}>
                    ${emp.empId} - ${emp.empName}
                </option>`
            ).join('');
            
            row.find('td:eq(2)').html(`<input type="text" class="form-control form-control-sm" value="${warehouseName}">`);
            row.find('td:eq(3)').html(`
                <select class="form-control form-control-sm">
                    <option value="원자재" ${warehouseType === '원자재' ? 'selected' : ''}>원자재</option>
                    <option value="반제품" ${warehouseType === '반제품' ? 'selected' : ''}>반제품</option>
                    <option value="완제품" ${warehouseType === '완제품' ? 'selected' : ''}>완제품</option>
                </select>
            `);
            row.find('td:eq(4)').html(`
                <select class="form-control form-control-sm">
                    <option value="Y" ${warehouseStatus === 'Y' ? 'selected' : ''}>운영중</option>
                    <option value="N" ${warehouseStatus === 'N' ? 'selected' : ''}>운영중지</option>
                </select>
            `);
            row.find('td:eq(5)').html(`<input type="text" class="form-control form-control-sm" value="${warehouseLocation === '-' ? '' : warehouseLocation}">`);
            
            row.find('td:eq(6)').html(`
                <select class="form-control form-control-sm">
                    ${employeeOptions}
                </select>
            `);
            
            row.find('td:eq(7)').html(`<input type="text" class="form-control form-control-sm" value="${description === '-' ? '' : description}">`);
            
            row.find('td:eq(8)').html(`
                <button class="btn btn-sm btn-success" onclick="saveRow('${row.data('id')}')">저장</button>
                <button class="btn btn-sm btn-danger" onclick="cancelEdit()">취소</button>
            `);
        }
    });
}

function saveRow(warehouseId) {
	const row = $(`tr[data-id="${warehouseId}"]`);
    const updateData = {
        warehouseId: warehouseId,
        warehouseName: row.find('td:eq(2) input').val(),
        warehouseType: row.find('td:eq(3) select').val(),
        warehouseStatus: row.find('td:eq(4) select').val(),
        warehouseLocation: row.find('td:eq(5) input').val(),
        empId: row.find('td:eq(6) select').val(),  
        description: row.find('td:eq(7) input').val()
    };
    
    if(!updateData.warehouseName) {
        alert('창고명은 필수 입력 항목입니다.');
        return;
    }
    
    ajaxCall('PUT', `/inventory/api/warehouses/${warehouseId}`, updateData, 
        () => {
            alert('수정 완료');
            currentEditRow = null;
            loadWarehouses();
        }
    );
}

function cancelEdit() {
    currentEditRow = null;
    loadWarehouses();
}

// 추가버튼
function showAddRow() {
    if($('#newRow').length > 0) {
        alert('이미 추가 중입니다.');
        return;
    }
    
    // 직원 목록 먼저 가져오기
    $.ajax({
        url: '/api/employees',
        type: 'GET',
        success: function(employees) {
            const employeeOptions = employees.map(emp => 
                `<option value="${emp.empId}">${emp.empId} - ${emp.empName}</option>`
            ).join('');
            
            const newRow = `
                <tr id="newRow" class="table-warning">
                    <td><input type="checkbox" disabled></td>
                    <td><input type="text" class="form-control form-control-sm" id="new_warehouseId" placeholder="창고ID"></td>
                    <td><input type="text" class="form-control form-control-sm" id="new_warehouseName" placeholder="창고명"></td>
                    <td>
                        <select class="form-control form-control-sm" id="new_warehouseType">
                            <option value="원자재">원자재</option>
                            <option value="반제품">반제품</option>
                            <option value="완제품">완제품</option>
                        </select>
                    </td>
                    <td>
                        <select class="form-control form-control-sm" id="new_warehouseStatus">
                            <option value="Y">운영중</option>
                            <option value="N">운영중지</option>
                        </select>
                    </td>
                    <td><input type="text" class="form-control form-control-sm" id="new_warehouseLocation" placeholder="창고위치"></td>
                    <td>
                        <select class="form-control form-control-sm" id="new_empId">
                            <option value="">담당자 선택</option>
                            ${employeeOptions}
                        </select>
                    </td>
                    <td><input type="text" class="form-control form-control-sm" id="new_description" placeholder="비고"></td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="saveWarehouse()">저장</button>
                        <button class="btn btn-sm btn-danger" onclick="cancelAdd()">취소</button>
                    </td>
                </tr>
            `;
            
            $('#warehouseTableBody').prepend(newRow);
        },
        error: function() {
            alert('직원 목록을 불러올 수 없습니다.');
        }
    });
}

function saveWarehouse() {
    const newWarehouse = {
        warehouseId: $('#new_warehouseId').val(),
        warehouseName: $('#new_warehouseName').val(),
        warehouseType: $('#new_warehouseType').val(),
        warehouseStatus: $('#new_warehouseStatus').val(),
        warehouseLocation: $('#new_warehouseLocation').val(),
        description: $('#new_description').val(),
        empId: $('#new_empId').val() 
    };
    
    if(!newWarehouse.warehouseId || !newWarehouse.warehouseName) {
        alert('창고ID와 창고명은 필수 입력 항목입니다.');
        return;
    }
    
    if(!newWarehouse.empId) {
        alert('담당자를 선택해주세요.');
        return;
    }
    
    ajaxCall('POST', '/inventory/api/warehouses', newWarehouse,
        (result) => {
            if(result.success) {
                alert('등록 완료');
                $('#newRow').remove();
                loadWarehouses();
            } else {
                alert(result.message);
            }
        }
    );
}

function cancelAdd() {
    $('#newRow').remove();
}

// 삭제
function deleteSelected() {
    const checked = $('.item-check:checked');
    if(checked.length === 0) {
        alert('삭제할 창고를 선택해주세요.');
        return;
    }
    
    if(confirm(checked.length + '개 창고를 삭제하시겠습니까?')) {
        const ids = checked.map(function() { return $(this).val(); }).get();
        
        ajaxCall('DELETE', '/inventory/api/warehouses', ids,
            (result) => {
                alert(result.message);
                if(result.success) {
                    loadWarehouses();
                }
            }
        );
    }
}

// 유틸리티
function ajaxCall(method, url, data, successCallback, errorCallback) {
    $.ajax({
        url: url,
        type: method,
        contentType: 'application/json',
        data: JSON.stringify(data),
        headers: {
            'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
        },
        success: successCallback,
        error: errorCallback || function() { alert('처리 실패'); }
    });
}

function getTypeColor(type) {
    const colors = {
        '원자재': 'badge-primary',
        '반제품': 'badge-warning',
        '완제품': 'badge-info'
    };
    return colors[type] || 'badge-secondary';
}

function formatDate(dateStr) {
    if(!dateStr) return '-';
    return new Date(dateStr).toLocaleDateString('ko-KR');
}

//창고 타입 옵션을 공통코드에서 가져오기
function loadWarehouseTypes() {
    $.ajax({
        url: '/api/common-codes/warehouse-types',
        type: 'GET',
        success: function(data) {
            // 검색 필터 select
            const filterSelect = $('#warehouseType');
            filterSelect.empty();
            filterSelect.append('<option value="">창고유형 전체</option>');
            
            // 공통코드 매핑
            filterSelect.append('<option value="원자재">원자재</option>'); 
            filterSelect.append('<option value="반제품">반제품</option>');
            filterSelect.append('<option value="완제품">완제품</option>');
        }
    });
}
</script>
</th:block>
</body>
</html>